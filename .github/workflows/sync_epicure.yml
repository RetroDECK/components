# This workflow keeps the 'epicure' branch in sync with 'main'.
# The epicure branch is hard-reset to match main, with the exception of
# 'automation_tools/alchemist/desired_versions.sh' which is preserved from epicure.

name: Sync epicure from main

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  sync-epicure:
    runs-on: ubuntu-latest
    steps:

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Sync epicure branch
        env:
          PROTECTED_FILE: "automation_tools/alchemist/desired_versions.sh"
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Save the protected file from epicure
          git show "origin/epicure:${PROTECTED_FILE}" > /tmp/preserved_file.sh

          # Reset epicure to match main
          git checkout -B epicure origin/main

          # Restore the protected file
          cp /tmp/preserved_file.sh "${PROTECTED_FILE}"

          # Only commit and push if the protected file actually differs from main's version
          if git diff --quiet; then
            echo "Protected file is identical to main, no additional commit needed"
          else
            git add "${PROTECTED_FILE}"
            git commit -m "Preserve epicure-specific ${PROTECTED_FILE}"
          fi

          git push --force origin epicure
